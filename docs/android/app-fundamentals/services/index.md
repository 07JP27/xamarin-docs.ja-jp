---
title: "Android のサービスを作成します。"
description: "このガイドでは、Xamarin.Android サービスは、アクティブなユーザー インターフェイスを使用せずに実行する作業を許可する Android のコンポーネントについて説明します。 サービスは、音楽の再生ファイルのダウンロード時間がかかる計算など、バック グラウンドで実行されるタスクに非常によく使用されなどです。 サービスが適しているさまざまなシナリオについて説明し、実行時間の長いバック グラウンド タスクを実行するとの両方でリモート プロシージャ コールのインターフェイスを提供するために、それらを実装する方法を示します。"
ms.topic: article
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: topgenorth
ms.author: toopge
ms.date: 03/19/2018
ms.openlocfilehash: 08392872037783e0caaef4f2b19127adbe95151b
ms.sourcegitcommit: cc38757f56aab53bce200e40f873eb8d0e5393c3
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/20/2018
---
# <a name="creating-android-services"></a>Android のサービスを作成します。

_このガイドでは、Xamarin.Android サービスは、アクティブなユーザー インターフェイスを使用せずに実行する作業を許可する Android のコンポーネントについて説明します。サービスは、音楽の再生ファイルのダウンロード時間がかかる計算など、バック グラウンドで実行されるタスクに非常によく使用されなどです。サービスが適しているさまざまなシナリオについて説明し、実行時間の長いバック グラウンド タスクを実行するとの両方でリモート プロシージャ コールのインターフェイスを提供するために、それらを実装する方法を示します。_

## <a name="android-services-overview"></a>Android のサービスの概要

デスクトップ アプリのようにモバイル アプリはします。 実際の画面、メモリ、記憶域スペース、および接続されている電源装置などのリソースが満載のデスクトップ、モバイル デバイスがありません。 これらの制約は、動作が異なるモバイル アプリを強制します。 たとえば、モバイル デバイス上の小さな画面は通常意味アプリを 1 つだけ (つまりアクティビティ) は、一度に表示します。 他のアクティビティは、バック グラウンドに移動され、作業を実行できず、一時停止状態にプッシュされます。 ただし、Android のアプリケーションがバック グラウンドは限りませんアプリの作業を続行することはできません。 

Android アプリケーションは構成されて 1 つ以上の次の 4 つの主要なコンポーネント:_アクティビティ_、_ブロードキャスト レシーバー_、_コンテンツ プロバイダー_、および_Services_です。 アクティビティは、により、ユーザーは、アプリケーションと対話する UI を提供するために多くの優れた Android アプリケーションの基礎です。 ただし、同時実行またはバック グラウンド作業する際に、アクティビティはありません常に最適な選択肢です。
 
Android でのバック グラウンド作業の主要なメカニズムは、_サービス_です。 Android のサービスは、ユーザー インターフェイスのない作業を行うように設計されたコンポーネントです。 サービスでは、ファイルをダウンロードする、音楽の再生、またはイメージにフィルターを適用可能性があります。 サービスは、プロセス間通信にも使用できます (_IPC_) Android アプリケーションの間です。 たとえば 1 つの Android アプリを使用できますが別のアプリから音楽プレーヤーのサービスまたはアプリは、サービスを経由して他のアプリへのデータ (個人の連絡先情報など) で公開される可能性がします。 

サービス、およびバック グラウンド処理を実行するには、その機能は、滑らかで滑らかなユーザー インターフェイスを提供するために重要です。 すべての Android アプリケーションが、_メイン スレッド_(とも呼ばれる、 _UI スレッド_) で、アクティビティが実行されます。 Android は、デバイスの応答性を維持に 60 秒あたりのフレーム レートでのユーザー インターフェイスを更新できる必要があります。 Android アプリをメイン スレッドで多くの作業を実行し、Android、フレームの脱落、順番に表示されるがスムーズでない UI を停止するかどうか (と呼ばれることも_janky_)。 これは 2 つのフレームを約 16 ミリ秒 (1 秒 60 フレームごと) までの時間の範囲で、UI スレッドで実行される任意の作業を完了しなければならないことを意味します。 

この問題に対処するため、開発者可能性がありますスレッドを使用で、アクティビティ、UI がブロックされるいくつかの作業を実行します。 ただし、これによって問題が発生する可能性があります。 非常に Android されますを破棄し、アクティビティの複数のインスタンスを再作成できます。 ただし、Android では、スレッド、メモリ リークにつながるは自動的には破棄されません。 これの主要な例は、ときに、[デバイスを回転](~/android/app-fundamentals/handling-rotation.md) &ndash; Android は、アクティビティのインスタンスを破棄して、新しいものを再作成を試みます。

![デバイスを回転させる、インスタンス 1 が破棄され、2 のインスタンスが作成されます。](images/image-01.png)

これは、メモリ リークの可能性&ndash;アクティビティの最初のインスタンスによって作成されたスレッドはまだ実行しています。 スレッドに、アクティビティの最初のインスタンスへの参照がある場合は、このオブジェクトを収集ガベージから Android をできなくなります。 ただし、アクティビティの 2 番目のインスタンスは作成されます (これは新しいスレッドをさらに作成可能性があります)。 複数回すばやく連続的にデバイスを回転させると、すべてのメモリを消費し、強制的に全体をメモリを再利用するアプリケーションを終了する Android 可能性があります。

原則として、として作業を実行する必要があります、アクティビティをよりも長くし、サービス作成するかどうその作業を実行します。 ただし、作業は、アクティビティのコンテキストで適切のみである場合作業を実行するスレッドを作成しより適切なあります。 たとえば、サービスで、フォト ギャラリーのアプリに追加された写真の縮小表示を作成するが起きる可能性があります。 ただし、スレッドはのみ音が聞こえますフォア グラウンドでのアクティビティがいくつかの音楽を再生する方が適切にあります。

バック グラウンド処理は、2 つの広範な分類に分類できます。

1. **長いタスクを実行中**&ndash;が明示的に停止するまで継続的な作業です。 例、_タスクの実行時間が長い_音楽をストリーム出力するアプリまたはセンサーから収集されたデータを監視する必要があります。 アプリケーションが表示されるユーザー インターフェイスを持たない場合でも、これらのタスクを実行する必要があります。
2. **定期的なタスク** &ndash; (とも呼ば、_ジョブ_) 定期的なタスクは、継続時間 (数秒) に比較的短い形式のスケジュールで実行され (つまり、1 日 1 回、1 週間のや、場合によってはで 1 回だけ、60 秒)。 この例は、インターネットからファイルをダウンロードまたは画像のサムネイルを生成します。

Android のサービスの 4 つの異なる種類があります。

* **サービスのバインド** &ndash; A_サービスのバインド_を持つ他のコンポーネント (通常は活動) にバインドされているサービスです。 バインドされているサービスは、連結されているコンポーネントや相互の対話をサービスにするインターフェイスを提供します。 サービスにバインドされているクライアントがなくなったら、後は、Android は、サービスをシャット ダウンします。 

* **`IntentService`** &ndash;  _`IntentService`_ の特殊なサブクラスが、`Service`クラスをサービスの作成と使用状況を簡略化します。 `IntentService`は個々 の自律的な呼び出しを処理するためのものです。 複数の呼び出しを処理できる同時に、サービスとは異なり、`IntentService`ように、_プロセッサのキューの作業_&ndash;作業をキューに登録と`IntentService`いずれかの各ジョブは 1 つのワーカー スレッドで一度に処理します。 通常、`IntentService`アクティビティまたはフラグメントにバインドされていません。 

* **サービスを開始しました** &ndash; A_サービスを開始しました_(アクティビティ) などの他の Android コンポーネントによって開始されており、明示的に示すものになるまでバック グラウンドで継続的を実行するサービスは、サービスが停止します。 バインドされているサービスとは異なり開始されるサービスに直接バインドされたすべてのクライアントはありません。 このため、必要に応じて、正常に再起動することがありますようには、開始されているサービスを設計する重要なです。

* **ハイブリッド サービス** &ndash; A_ハイブリッド サービス_の特性を持つサービスは、_サービスを開始しました_と_サービスのバインド_です。 コンポーネントがバインドされてか、一部のイベントによって開始する必要があるときに、によってハイブリッド サービスを開始できます。 クライアント コンポーネントは、可能性があります。 またはハイブリッド サービスにバインドされていない可能性があります。 ハイブリッド サービスは、停止するには、明示的に伝えられるまで、またはバインドされている複数のクライアントが引き続き実行します。

使用するサービスの種類は、アプリケーションの要件に大きく依存します。 原則として、として、`IntentService`またはバインドされているサービスの Android アプリケーションを実行する必要があります、ほとんどのタスクのための十分なため、これら 2 つの種類のサービスのいずれかに基本設定を指定する必要があります。 `IntentService` 「ワンショット」などのタスク、バインドされているサービスされる適切なときに、アクティビティ/フラグメントと頻繁に対話が必要なときに、ファイルのダウンロードをお勧めします。 

ほとんどのサービスがバック グラウンドで実行中と呼ばれる特殊なサブ カテゴリ、_フォア グラウンド サービス_です。 (音楽の再生) などのユーザーの一部の作業を実行する優先順位が高い (通常のサービスとの比較) が指定されたサービスです。 

同じデバイスに、独自のプロセスで、サービスを実行することも、これとも呼ば、_リモート サービス_か、または、_アウト プロセス サービス_です。 これを作成する多くの労力を必要とが、アプリケーションが他のアプリケーションと機能を共有する必要がある場合に役に立ちますおよび向上するか、場合によっては、アプリケーションのユーザー エクスペリエンスです。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 でバック グラウンドの実行の制限

バック グラウンドで自由に実行する権限がある Android 8.0 (API レベル 26) で不要になった Android アプリケーションを起動します。 フォア グラウンドでは、アプリは起動し、制限なくサービスを実行します。 Android は、アプリケーションは、バック グラウンドに移動したときは、アプリが起動し、サービスを使用する時間数に与えられます。 時間が経過すると、アプリはすべてのサービスを起動できなくと開始されたすべてのサービスは終了されます。 このポイントは、アプリの作業を行うことはできません。 Android アプリケーションをフォア グラウンドで、次の条件のいずれかが満たされた場合を検討します。

* (開始または停止) の表示されているアクティビティがあります。
* アプリには、フォア グラウンド サービスが開始されました。
* 別のアプリでは、フォア グラウンドでがあり、バック グラウンドでそれ以外の場合になるアプリからのコンポーネントが使用します。 この例は、フォア グラウンドでは、アプリケーション A がによって提供されるサービスにバインドされている場合アプリケーション アプリケーション B がし、また、フォア グラウンドでと見なされ、バック グラウンドでの Android によって終了していません。

状況によってはここで、場合でも、アプリは、バック グラウンドでは、Android アプリをウェイク アップされいくつかの作業を実行するアプリを許可するが数分間、これらの制約を緩和します。
* 優先度の高い Firebase クラウド メッセージは、アプリケーションによって受信されます。
* アプリでは、ブロードキャストをなどで受信します。 
* アプリケーションを受信、実行、`PendingIntent`通知に応答します。

既存の Xamarin.Android アプリケーションは、Android 8.0 で生じる可能性のある問題を回避するバック グラウンド処理を実行する方法を変更する必要があります。 Android のサービスにいくつかの実用的な alterantives を次に示します。

* **Android のジョブのスケジューラを使用して、バック グラウンドで実行する作業のスケジュール設定、または[Firebase ジョブ ディスパッチャー](~/android/platform/firebase-job-dispatcher.md)**  &ndash;これら 2 つのライブラリ アプリケーションでバックグラウンド作業を分離するためのフレームワークを提供します。_ジョブ_、個々 の作業単位です。 アプリことができますし、日時、オペレーティング システムといくつかの条件を使用してジョブについてジョブを実行できます。
* **フォア グラウンドでサービスを開始**&ndash;フォア グラウンド サービスは、アプリがバック グラウンドで一部のタスクを実行する必要がある場合に役立ちますし、ユーザーがそのタスクを定期的にやり取りする必要があります。 ユーザーは、アプリは、バック グラウンド タスクを実行しているし、監視またはタスクとの対話方法も提供を認識できるように、フォア グラウンド サービスは継続的な通知に表示されます。 この例は、ユーザーに、ポッド キャストを再生または後で利用できるように、ポッド キャスト エピソードをおそらくダウンロードされるポッドキャスティング アプリになります。 
* **優先度の高い Firebase クラウド メッセージ (FCM) を使用して**&ndash;ときに Android にアプリの最優先事項 FCM を受け取り、そのアプリを短時間のバック グラウンドでサービスを実行できるようになります。 バック グラウンドでアプリをポーリングするバック グラウンド サービスを持つように適切な代替手段になります。 
* **作業とアプリが前面になるを遅らせる**&ndash;以上の解決策のいずれも、実行可能なかどうかは、アプリが一時停止して、アプリが前面に作業を再開する、独自の方法を開発する必要があります。

## <a name="related-links"></a>関連リンク

* [Android の Oreo バック グラウンドで実行を制限します。](https://www.youtube.com/watch?v=Pumf_4yjTMc)